<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dracula's Differential Dungeon</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --ink: #000000;
      --velvet: #0a0004;
      --plum: #1a0033;
      --accent: #9d4edd;
      --accent-2: #c77dff;
      --accent-3: #e0aaff;
      --text: #f8f8f2;
      --muted: #d4a5ff;
      --danger: #9d4edd;
      --success: #c77dff;
    }

    * {
      box-sizing: border-box;
    }

    @media (hover: hover) and (pointer: fine) {
      * {
        cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="12" r="8" fill="%239d4edd" opacity="0.4"/><circle cx="12" cy="12" r="3" fill="%23c77dff"/></svg>') 12 12, auto;
      }

      button, select, input, a, label {
        cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 2L15 10L22 12L15 14L12 22L9 14L2 12L9 10Z" fill="%239d4edd"/></svg>') 12 12, pointer;
      }
    }

    @media (hover: none) and (pointer: coarse) {
      button, select, input, a, label {
        cursor: pointer;
      }
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Poppins", sans-serif;
      color: var(--text);
      background: radial-gradient(circle at 20% 15%, rgba(157, 74, 221, 0.3), transparent 55%),
        radial-gradient(circle at 80% 20%, rgba(0, 0, 0, 0.8), transparent 50%),
        linear-gradient(135deg, #000000, #1a0033 55%, #0d001a);
      position: relative;
      overflow-x: hidden;
      animation: screenFlicker 10s ease-in-out infinite;
      width: 100%;
      max-width: 100vw;
    }

    html {
      overflow-x: hidden;
      width: 100%;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image:
        radial-gradient(2px 2px at 20px 30px, rgba(157,74,221,0.3), rgba(0,0,0,0)),
        radial-gradient(2px 2px at 60px 70px, rgba(157,74,221,0.3), rgba(0,0,0,0)),
        radial-gradient(1px 1px at 50px 50px, rgba(157,74,221,0.3), rgba(0,0,0,0)),
        radial-gradient(1px 1px at 130px 80px, rgba(157,74,221,0.3), rgba(0,0,0,0)),
        radial-gradient(2px 2px at 90px 10px, rgba(157,74,221,0.3), rgba(0,0,0,0));
      background-size: 200px 200px;
      background-repeat: repeat;
      opacity: 0.4;
      animation: purpleGlow 20s linear infinite;
      pointer-events: none;
      z-index: -1;
    }

    @keyframes purpleGlow {
      0% { opacity: 0.3; }
      50% { opacity: 0.5; }
      100% { opacity: 0.3; }
    }

    header {
      padding: 2.6rem 9vw 1.3rem;
      text-align: left;
      width: 100%;
      max-width: 100vw;
      overflow-x: hidden;
    }

    @media (max-width: 720px) {
      header {
        padding: 1.5rem 5vw 1rem;
      }
    }

    header h1 {
      margin: 0;
      font-size: clamp(2rem, 5vw, 3.5rem);
      letter-spacing: 0.08em;
      color: #c77dff;
      text-transform: uppercase;
      text-shadow: 0 0 40px rgba(157, 74, 221, 1),
                   0 0 80px rgba(199, 125, 255, 0.8),
                   0 5px 15px rgba(0, 0, 0, 0.9),
                   0 10px 30px rgba(157, 74, 221, 0.6);
      animation: vampireGlow 3s ease-in-out infinite;
      position: relative;
    }

    header h1::after {
      content: '🩸';
      position: absolute;
      right: -50px;
      top: -10px;
      font-size: 2rem;
      animation: drip 4s ease-in-out infinite;
    }

    @keyframes vampireGlow {
      0%, 100% {
        text-shadow: 0 0 30px rgba(157, 74, 221, 0.9),
                     0 0 60px rgba(199, 125, 255, 0.7),
                     0 5px 10px rgba(0, 0, 0, 0.8);
      }
      50% {
        text-shadow: 0 0 50px rgba(157, 74, 221, 1),
                     0 0 80px rgba(199, 125, 255, 0.9),
                     0 5px 15px rgba(0, 0, 0, 0.9);
      }
    }

    @keyframes drip {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(10px); }
    }

    header p {
      margin: 0.8rem 0 0;
      max-width: 640px;
      color: var(--muted);
      line-height: 1.6;
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1fr);
      gap: 1.8rem;
      padding: 0 9vw 3.5rem;
      position: relative;
      z-index: 1;
      width: 100%;
      max-width: 100vw;
      overflow-x: hidden;
    }

    @media (max-width: 720px) {
      main {
        padding: 0 5vw 2rem;
        gap: 1.2rem;
      }
    }

    .panel {
      background: rgba(10, 0, 10, 0.95);
      border: 2px solid rgba(157, 74, 221, 0.6);
      border-radius: 22px;
      padding: 1.6rem;
      box-shadow: 0 18px 44px rgba(0, 0, 0, 0.9),
                  inset 0 0 30px rgba(157, 74, 221, 0.15),
                  0 0 30px rgba(157, 74, 221, 0.3);
      backdrop-filter: blur(10px);
      position: relative;
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    @media (max-width: 720px) {
      .panel {
        padding: 1.2rem;
        border-radius: 16px;
      }
    }

    .panel::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      border-radius: 22px;
      background: linear-gradient(135deg, rgba(157, 74, 221, 0.4), transparent);
      z-index: -1;
      animation: pulsePanel 4s ease-in-out infinite;
    }

    @keyframes pulsePanel {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.6; }
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1.4rem;
    }

    .controls label {
      display: flex;
      flex-direction: column;
      font-size: 0.8rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
      gap: 0.35rem;
    }

    select,
    button,
    input[type="text"] {
      border: none;
      border-radius: 999px;
      padding: 0.65rem 1.1rem;
      background: rgba(19, 13, 28, 0.9);
      color: var(--text);
      font-family: "Fira Code", monospace;
      font-size: 0.95rem;
      box-shadow: inset 0 0 0 1px rgba(189, 147, 249, 0.16);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    select:focus,
    input:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(189, 147, 249, 0.65);
    }

    button {
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      background: linear-gradient(135deg, rgba(157, 74, 221, 0.95), rgba(199, 125, 255, 0.85));
      box-shadow: 0 10px 24px rgba(157, 74, 221, 0.7),
                  inset 0 -2px 10px rgba(0, 0, 0, 0.5),
                  0 0 20px rgba(157, 74, 221, 0.4);
      font-weight: 600;
      position: relative;
      overflow: hidden;
    }

    button::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(157, 74, 221, 0.3), transparent);
      animation: buttonPulse 2s ease-in-out infinite;
    }

    @keyframes buttonPulse {
      0%, 100% { transform: scale(0); opacity: 0; }
      50% { transform: scale(1); opacity: 1; }
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 30px rgba(157, 74, 221, 0.8),
                  inset 0 -2px 10px rgba(0, 0, 0, 0.7);
    }

    button.secondary {
      background: linear-gradient(135deg, rgba(157, 74, 221, 0.95), rgba(140, 60, 200, 0.85));
      box-shadow: 0 10px 22px rgba(157, 74, 221, 0.6),
                  inset 0 -2px 10px rgba(0, 0, 0, 0.5),
                  0 0 20px rgba(157, 74, 221, 0.4);
    }

    button.ghost {
      background: transparent;
      box-shadow: inset 0 0 0 2px rgba(157, 74, 221, 0.8);
      color: #c77dff;
      text-shadow: 0 0 10px rgba(157, 74, 221, 0.5);
    }

    .question-card {
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
    }

    .question-header {
      display: flex;
      justify-content: space-between;
      gap: 0.8rem;
      align-items: baseline;
    }

    .topic-tag {
      font-size: 0.75rem;
      color: #c77dff;
      background: rgba(157, 74, 221, 0.25);
      padding: 0.35rem 0.7rem;
      border-radius: 999px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      border: 1px solid rgba(157, 74, 221, 0.6);
      text-shadow: 0 0 10px rgba(157, 74, 221, 0.8);
    }

    .difficulty-tag {
      font-size: 0.75rem;
      color: #e0aaff;
      letter-spacing: 0.08em;
      font-weight: 700;
    }

    .prompt {
      background: rgba(18, 12, 28, 0.85);
      border-radius: 16px;
      padding: 1.1rem 1.3rem;
      font-family: "Fira Code", monospace;
      line-height: 1.6;
      box-shadow: inset 0 0 0 1px rgba(189, 147, 249, 0.22);
      width: 100%;
      max-width: 100%;
      overflow-x: auto;
      overflow-y: hidden;
    }

    @media (max-width: 720px) {
      .prompt {
        padding: 1rem;
        font-size: 0.9rem;
        overflow-x: scroll;
        -webkit-overflow-scrolling: touch;
      }
    }

    /* Ensure MathJax content scales on mobile */
    .prompt mjx-container {
      max-width: 100% !important;
      overflow-x: auto !important;
      overflow-y: hidden !important;
    }

    @media (max-width: 720px) {
      .prompt mjx-container {
        font-size: 90% !important;
      }
    }

    .options {
      display: grid;
      gap: 0.8rem;
    }

    .option-card {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 1rem 1.2rem;
      background: rgba(26, 18, 36, 0.9);
      border-radius: 12px;
      border: 1px solid transparent;
      transition: transform 0.2s ease, border 0.2s ease;
      cursor: pointer;
      min-height: 60px;
      -webkit-tap-highlight-color: rgba(157, 74, 221, 0.3);
      touch-action: manipulation;
    }

    .option-card:hover {
      transform: translateY(-1px);
      border-color: rgba(189, 147, 249, 0.4);
    }

    .option-card:active {
      transform: translateY(0);
      background: rgba(157, 74, 221, 0.2);
    }

    .option-card input {
      accent-color: var(--accent-3);
      transform: scale(1.4);
      width: 20px;
      height: 20px;
      cursor: pointer;
      flex-shrink: 0;
    }

    .option-card span {
      cursor: pointer;
      flex: 1;
      user-select: none;
      -webkit-user-select: none;
      word-wrap: break-word;
      overflow-wrap: break-word;
      max-width: 100%;
      overflow-x: auto;
    }

    /* Ensure MathJax in options scales on mobile */
    .option-card mjx-container {
      max-width: 100% !important;
      overflow-x: auto !important;
      overflow-y: hidden !important;
    }

    @media (max-width: 720px) {
      .option-card {
        padding: 1.2rem 1.4rem;
        min-height: 70px;
      }

      .option-card input {
        transform: scale(1.8);
        width: 24px;
        height: 24px;
      }

      .option-card span {
        font-size: 0.9rem;
      }

      .option-card mjx-container {
        font-size: 85% !important;
      }
    }

    .free-response input {
      width: 100%;
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .feedback {
      min-height: 1.8rem;
      font-weight: 600;
      letter-spacing: 0.05em;
    }

    .feedback.success {
      color: var(--success);
    }

    .feedback.error {
      color: var(--danger);
    }

    .hint-stage {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }

    .hint-stage p {
      margin: 0;
      padding: 0.75rem 1rem;
      border-radius: 12px;
      background: rgba(18, 12, 28, 0.8);
      border: 1px dashed rgba(189, 147, 249, 0.32);
      font-size: 0.95rem;
      color: var(--muted);
    }

    .solution {
      margin-top: 0.8rem;
      padding: 1rem 1.2rem;
      border-radius: 16px;
      background: rgba(15, 10, 24, 0.9);
      border: 1px solid rgba(189, 147, 249, 0.25);
      display: none;
    }

    .solution.active {
      display: block;
    }

    .sidebar {
      display: grid;
      gap: 1.3rem;
    }

    .stat-card {
      background: rgba(10, 0, 10, 0.92);
      border-radius: 18px;
      padding: 1.2rem;
      border: 2px solid rgba(157, 74, 221, 0.6);
      display: grid;
      gap: 0.7rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8),
                  inset 0 0 20px rgba(157, 74, 221, 0.15),
                  0 0 20px rgba(157, 74, 221, 0.3);
    }

    .stat-card h3 {
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #c77dff;
      font-size: 0.95rem;
      text-shadow: 0 0 15px rgba(157, 74, 221, 0.9);
      font-weight: 700;
    }

    .stat-value {
      font-family: "Fira Code", monospace;
      font-size: 1.6rem;
    }

    .timer {
      font-family: "Fira Code", monospace;
      font-size: 1.3rem;
      color: var(--accent-2);
    }

    progress {
      width: 100%;
      height: 10px;
      border-radius: 999px;
      overflow: hidden;
      background: rgba(55, 48, 78, 0.4);
    }

    progress::-webkit-progress-value {
      background: linear-gradient(135deg, rgba(80, 250, 123, 0.85), rgba(189, 147, 249, 0.85));
    }

    footer {
      padding: 2.5rem 9vw 3rem;
      color: var(--muted);
      text-align: center;
      font-size: 0.9rem;
    }

    .float-glow {
      position: fixed;
      top: -100px;
      left: -60px;
      width: 300px;
      height: 300px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(157, 74, 221, 0.7), rgba(157, 74, 221, 0));
      filter: blur(40px);
      pointer-events: none;
      animation: pulse 10s ease-in-out infinite alternate, drift 20s ease-in-out infinite;
      z-index: -1;
    }

    @keyframes drift {
      0%, 100% {
        transform: translate(0, 0);
      }
      25% {
        transform: translate(100px, 50px);
      }
      50% {
        transform: translate(-50px, 100px);
      }
      75% {
        transform: translate(80px, -30px);
      }
    }

    @keyframes screenFlicker {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.97; }
      51% { opacity: 1; }
      52% { opacity: 0.95; }
      53% { opacity: 1; }
    }

    .blood-drip {
      position: fixed;
      top: -20px;
      width: 2px;
      height: 0;
      background: linear-gradient(to bottom, rgba(157, 74, 221, 0.8), rgba(157, 74, 221, 0));
      pointer-events: none;
      animation: dripping 3s ease-in infinite;
      z-index: 0;
    }

    .blood-drip:nth-child(9) {
      left: 10%;
      animation-delay: 0s;
    }

    .blood-drip:nth-child(10) {
      left: 45%;
      animation-delay: 1.5s;
    }

    .blood-drip:nth-child(11) {
      left: 78%;
      animation-delay: 0.8s;
    }

    @keyframes dripping {
      0% {
        height: 0;
        top: -20px;
        opacity: 1;
      }
      50% {
        height: 100px;
        opacity: 0.8;
      }
      100% {
        height: 120px;
        top: 200px;
        opacity: 0;
      }
    }

    .bat {
      position: fixed;
      width: 70px;
      aspect-ratio: 1;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 32"><path fill="%239d4edd" d="M9 13c4-5 9-9 16-9s7 2 7 2 0-3 3-3 3 3 3 3 0-2 3-2 5 4 5 4l4-2-1 4 3 3-4 2 2 5-5-2s-3 5-7 5-6-3-6-3-3 3-7 3-9-6-9-6l-5 2 2-6-4-1 3-3-1-4z"/></svg>') no-repeat center/contain;
      opacity: 0.8;
      pointer-events: none;
      animation: bat 14s linear infinite;
      filter: drop-shadow(0 0 15px rgba(157, 74, 221, 0.9));
    }

    .bat:nth-of-type(2) {
      top: 18%;
      right: 12%;
      animation-duration: 18s;
      transform: scale(1.3);
    }

    .bat:nth-of-type(3) {
      bottom: 18%;
      left: 18%;
      animation-duration: 16s;
    }

    .skull {
      position: fixed;
      font-size: 3rem;
      opacity: 0.25;
      pointer-events: none;
      animation: float 15s ease-in-out infinite;
      filter: drop-shadow(0 0 25px rgba(157, 74, 221, 0.9));
    }

    .skull:nth-of-type(5) {
      top: 5%;
      right: 5%;
      animation-delay: -3s;
    }

    .skull:nth-of-type(6) {
      bottom: 15%;
      right: 20%;
      animation-delay: -7s;
    }

    .spider {
      position: fixed;
      font-size: 2rem;
      opacity: 0.3;
      pointer-events: none;
      animation: swing 5s ease-in-out infinite;
      transform-origin: top center;
    }

    .spider:nth-of-type(7) {
      top: 0;
      left: 15%;
      animation-delay: -1s;
    }

    .spider:nth-of-type(8) {
      top: 0;
      right: 30%;
      animation-delay: -3s;
    }

    @keyframes float {
      0%, 100% {
        transform: translateY(0) rotate(0deg);
      }
      25% {
        transform: translateY(-20px) rotate(5deg);
      }
      50% {
        transform: translateY(0) rotate(-5deg);
      }
      75% {
        transform: translateY(-15px) rotate(3deg);
      }
    }

    @keyframes swing {
      0%, 100% {
        transform: rotate(-10deg);
      }
      50% {
        transform: rotate(10deg);
      }
    }

    @keyframes pulse {
      from {
        transform: scale(0.85);
        opacity: 0.4;
      }
      to {
        transform: scale(1.05);
        opacity: 0.75;
      }
    }

    @keyframes bat {
      0% {
        transform: translateY(0) translateX(-10px);
      }
      25% {
        transform: translateY(-14px) translateX(20px);
      }
      50% {
        transform: translateY(6px) translateX(35px);
      }
      75% {
        transform: translateY(-18px) translateX(5px);
      }
      100% {
        transform: translateY(0) translateX(-10px);
      }
    }

    @media (max-width: 980px) {
      main {
        grid-template-columns: 1fr;
      }
    }

    .sidebar {
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
    }

    .stat-card {
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    @media (max-width: 720px) {
      .controls {
        flex-direction: column;
        align-items: stretch;
      }

      button,
      select,
      input {
        width: 100%;
        min-height: 48px;
        font-size: 1rem;
        touch-action: manipulation;
      }

      button {
        padding: 0.9rem 1.3rem;
      }

      .actions {
        flex-direction: column;
      }

      .options {
        gap: 1rem;
      }
    }
  </style>
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [["$", "$"], ["\\\\(", "\\\\)"]],
        displayMath: [["$$", "$$"], ["\\\\[", "\\\\]"]]
      },
      svg: { fontCache: "global" },
      options: { renderActions: { addMenu: [] } }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
</head>
<body>
  <div class="float-glow"></div>
  <div class="bat" style="top: 12%; left: 22%;"></div>
  <div class="bat"></div>
  <div class="bat"></div>
  <div class="skull">💀</div>
  <div class="skull">☠️</div>
  <div class="spider">🕷️</div>
  <div class="spider">🕸️</div>
  <div class="blood-drip"></div>
  <div class="blood-drip"></div>
  <div class="blood-drip"></div>
  <header>
    <h1>🦇 DRACULA'S DIFFERENTIAL DUNGEON 🦇</h1>
    <p style="color: #c77dff; font-weight: 600; text-shadow: 0 0 20px rgba(157, 74, 221, 0.8), 0 0 40px rgba(157, 74, 221, 0.4);">
      ⚠️ ENTER AT YOUR OWN RISK ⚠️ You've stumbled into the cursed crypt where mathematical nightmares dwell.
      Face unholy differential equations, battle demonic Laplace transforms, and survive until dawn... if you can.
      Every wrong answer feeds the darkness. Every correct answer may grant you escape... or pull you deeper into the abyss.
      The clock is ticking. The creatures are watching. WILL YOU SURVIVE?
    </p>
  </header>
  <main>
    <section class="panel">
      <div class="controls">
        <label>
          Topic
          <select id="topicFilter"></select>
        </label>
        <label>
          Difficulty
          <select id="difficultyFilter">
            <option value="all">All Horrors</option>
            <option value="coffin">💀 Freshly Buried</option>
            <option value="fang">🩸 Bloodthirsty</option>
            <option value="nightmare">☠️ ETERNAL DAMNATION</option>
          </select>
        </label>
        <button id="newQuestionBtn">⚰️ SUMMON EVIL ⚰️</button>
        <button id="flashcardBtn" class="ghost">🕯️ Cursed Study Mode</button>
      </div>
      <div class="question-card">
        <div class="question-header">
          <span class="topic-tag" id="topicTag">🔮 Awaiting Your Doom</span>
          <span class="difficulty-tag" id="difficultyTag">Terror Level</span>
        </div>
        <div class="prompt" id="prompt" style="border: 2px solid rgba(157, 74, 221, 0.6); background: rgba(0, 0, 0, 0.7); box-shadow: 0 0 20px rgba(157, 74, 221, 0.3);">
          💀 The crypt awaits... Select your curse and summon your mathematical nightmare. Choose wisely, for each problem may be your last...
        </div>
        <div class="options" id="options"></div>
        <div class="actions">
          <button id="checkAnswerBtn" class="secondary">🗡️ FACE YOUR FATE</button>
          <button id="hintBtn" class="ghost">👻 Spectral Whisper</button>
          <button id="solutionBtn" class="ghost">⚰️ Surrender to Death</button>
        </div>
        <div class="feedback" id="feedback"></div>
        <div class="hint-stage" id="hintStage"></div>
        <div class="solution" id="solutionBlock"></div>
      </div>
    </section>
    <aside class="sidebar">
      <div class="stat-card">
        <h3>💀 SOUL COUNT 💀</h3>
        <div class="stat-value" id="scoreCounter" style="color: #9d4edd; text-shadow: 0 0 15px rgba(157, 74, 221, 0.8);">0 / 0</div>
        <progress id="accuracyBar" value="0" max="100"></progress>
        <span id="accuracyLabel" style="color: #e0aaff;">Survival Rate: 0%</span>
        <span id="streakLabel" style="color: #e0aaff;">Kill Streak: 0 (Best 0)</span>
      </div>
      <div class="stat-card">
        <h3>⏱️ DEATH COUNTDOWN ⏱️</h3>
        <div class="timer" id="timerDisplay" style="color: #9d4edd; font-size: 2rem; text-shadow: 0 0 20px rgba(157, 74, 221, 0.9);">03:00</div>
        <div class="actions" style="margin-top: 0.4rem;">
          <button id="startTimerBtn">🔪 BEGIN MASSACRE</button>
          <button id="stopTimerBtn" class="ghost">🛑 Flee</button>
        </div>
        <p style="margin:0; color: #e0aaff; font-size:0.85rem; font-weight: 600;">
          ⚠️ How many demons can you slay before your time runs out? The darkness closes in... 180 seconds until DOOM!
        </p>
      </div>
      <div class="stat-card">
        <h3>🩸 CRYPT CHRONICLES 🩸</h3>
        <div id="historyLog" style="max-height: 200px; overflow-y: auto; font-size: 0.9rem; color: var(--muted);"></div>
      </div>
      <div class="stat-card">
        <h3>📜 SURVIVAL RULES 📜</h3>
        <ol style="margin:0; padding-left: 1.1rem; color: #e0aaff; line-height: 1.6; font-weight: 600;">
          <li>🔮 Prepare your ritual before confronting the beast.</li>
          <li>👻 Beware: spectral whispers weaken your power.</li>
          <li>⚰️ Record each battle in your grimoire of shadows.</li>
          <li>🩸 WRONG ANSWERS FEED THE VAMPIRE!</li>
        </ol>
      </div>
    </aside>
  </main>
  <footer style="color: #c77dff; font-weight: 600; text-shadow: 0 0 20px rgba(157, 74, 221, 0.8), 0 0 40px rgba(157, 74, 221, 0.4);">
    ⚠️ WARNING FROM THE CRYPT KEEPER ⚠️<br>
    The spirits of failed students haunt these halls. Their screams echo through every unsolved equation.
    Will you join them in eternal mathematical torment? Or will you prove your worth and escape before dawn?
    Remember: Every derivative could be your last. Every integral leads deeper into darkness.
    THE CALCULUS REAPER IS WATCHING... 💀🦇☠️
  </footer>
  <script>
    const difficultyNames = {
      coffin: "💀 Freshly Buried",
      fang: "🩸 Bloodthirsty",
      nightmare: "☠️ ETERNAL DAMNATION"
    };

    const questionBank = [
      {
        id: "linear-if",
        topic: "First-Order Linear",
        difficulty: "coffin",
        type: "multipleChoice",
        prompt: "Solve the IVP $y' + 2y = e^{x}$ with $y(0)=0$.",
        options: [
          "$y(x) = \\tfrac{1}{3} e^{x} - \\tfrac{1}{3} e^{-2x}$",
          "$y(x) = e^{x} - e^{-2x}$",
          "$y(x) = \\tfrac{1}{2} e^{x} - \\tfrac{1}{2} e^{-2x}$",
          "$y(x) = e^{-2x}$"
        ],
        answerIndex: 0,
        hints: [
          "Integrating factor: $\\mu(x) = e^{2x}$.",
          "Solve $e^{2x} y = \\int e^{3x}\\,dx$ and apply the initial value."
        ],
        explanation: "Multiplying by $e^{2x}$ gives $\\frac{d}{dx}(e^{2x}y) = e^{3x}$. Integrate to get $e^{2x}y = \\tfrac{1}{3} e^{3x} + C$, and $y(0)=0$ forces $C = -\\tfrac{1}{3}$. Thus $y = \\tfrac{1}{3} e^{x} - \\tfrac{1}{3} e^{-2x}$."
      },
      {
        id: "separable-1",
        topic: "Separable",
        difficulty: "coffin",
        type: "multipleChoice",
        prompt: "Solve $\\dfrac{dy}{dx} = y \\cos x$ with $y(0)=3$.",
        options: [
          "$y = 3 e^{\\sin x}$",
          "$y = 3 e^{\\cos x}$",
          "$y = 3 e^{1-\\sin x}$",
          "$y = 3 e^{-\\sin x}$"
        ],
        answerIndex: 0,
        hints: [
          "Separate: $\\dfrac{dy}{y} = \\cos x\\,dx$.",
          "Integrate both sides and use $y(0)=3$."
        ],
        explanation: "$\\ln|y| = \\sin x + C$ leads to $y = 3 e^{\\sin x}$ after using the initial value."
      },
      {
        id: "exact-1",
        topic: "Exact",
        difficulty: "fang",
        type: "multipleChoice",
        prompt: "For $(2xy + 1)dx + (x^{2} + 4y)dy = 0$, choose the implicit solution.",
        options: [
          "$x^{2}y + x + 2y^{2} = C$",
          "$x^{2}y + 2x + 2y^{2} = C$",
          "$x^{2}y + x + 4y^{2} = C$",
          "$x^{2}y + 2y^{2} = C$"
        ],
        answerIndex: 0,
        hints: [
          "$M_y = N_x = 2x$ so the form is exact.",
          "Integrate $M$ with respect to $x$, then match with $N$."
        ],
        explanation: "Integrating $M$ gives $x^{2}y + x + g(y)$. Matching $N$ forces $g'(y)=4y$, so $g=2y^{2}$."
      },
      {
        id: "second-order-ivp",
        topic: "Second-Order Linear",
        difficulty: "nightmare",
        type: "shortAnswer",
        prompt: "Solve $y'' - 3y' + 2y = 0$ with $y(0)=1$, $y'(0)=0$ and report $y(1)$ rounded to three decimals.",
        answer: { type: "numeric", value: -1.953, tolerance: 0.01 },
        hints: [
          "Roots of $r^{2} - 3r + 2$ are $1$ and $2$.",
          "Solve for $C_{1}, C_{2}$, then evaluate at $x=1$."
        ],
        explanation: "The solution $y = 2e^{x} - e^{2x}$ gives $y(1) = 2e - e^{2} \\approx -1.953$."
      },
      {
        id: "laplace-1",
        topic: "Laplace Transforms",
        difficulty: "fang",
        type: "multipleChoice",
        prompt: "Compute $\\mathcal{L}\\{t e^{2t}\\}$.",
        options: [
          "$\\dfrac{1}{(s-2)^{2}}$",
          "$\\dfrac{s}{(s-2)^{2}}$",
          "$\\dfrac{1}{(s-2)^{3}}$",
          "$\\dfrac{2}{(s-2)^{2}}$"
        ],
        answerIndex: 0,
        hints: [
          "Use $\\mathcal{L}\\{t\\} = 1/s^{2}$ and the shift theorem.",
          "Replace $s$ by $s-2$."
        ],
        explanation: "Shifting gives $\\mathcal{L}\\{t e^{2t}\\} = 1/(s-2)^{2}$."
      },
      {
        id: "laplace-ivp",
        topic: "Laplace Transforms",
        difficulty: "nightmare",
        type: "multipleChoice",
        prompt: "Solve $y'' + 4y = 8\\sin(2t)$ with $y(0)=0$, $y'(0)=1$.",
        options: [
          "$y = -2t\\cos(2t) + \\tfrac{3}{2}\\sin(2t)$",
          "$y = \\tfrac{1}{2} t \\sin(2t)$",
          "$y = t \\sin(2t)$",
          "$y = \\tfrac{1}{2} t \\sin(2t) + \\tfrac{1}{2} \\cos(2t)$"
        ],
        answerIndex: 0,
        hints: [
          "Transform both sides and solve for $Y(s)$.",
          "You should get $Y(s) = \\dfrac{1}{s^{2}+4} + \\dfrac{16}{(s^{2}+4)^{2}}$ before inverting."
        ],
        explanation: "After applying initial conditions, $(s^{2}+4)Y(s) - 1 = \\dfrac{16}{s^{2}+4}$, so $Y(s) = \\dfrac{1}{s^{2}+4} + \\dfrac{16}{(s^{2}+4)^{2}}$. Taking the inverse transform gives $y(t) = -2t\\cos(2t) + \\tfrac{3}{2}\\sin(2t)$."
      },
      {
        id: "systems-spiral",
        topic: "Linear Systems",
        difficulty: "fang",
        type: "multipleChoice",
        prompt: "Classify the origin for $\\mathbf{x}' = \\begin{pmatrix}-1 & -4 \\\\ 1 & -1\\end{pmatrix} \\mathbf{x}$.",
        options: [
          "Stable node",
          "Unstable node",
          "Center",
          "Stable spiral"
        ],
        answerIndex: 3,
        hints: [
          "Characteristic values are $-1 \\pm 2i$.",
          "Negative real part means spiral sink."
        ],
        explanation: "Complex eigenvalues with negative real part imply a stable spiral."
      },
      {
        id: "logistic",
        topic: "Nonlinear Models",
        difficulty: "fang",
        type: "shortAnswer",
        prompt: "For $y' = 0.6y(1 - y/12)$, $y(0)=2$, compute $y(5)$ (1 decimal).",
        answer: { type: "numeric", value: 9.6, tolerance: 0.2 },
        hints: [
          "General form: $\\frac{M}{1+Ae^{-kt}}$ with $M=12$.",
          "Solve for $A$ using $y(0)=2$."
        ],
        explanation: "With $A=5$, $y(t) = \\frac{12}{1 + 5e^{-0.6t}}$, so $y(5) \\approx 9.61$."
      },
      {
        id: "heat-equation",
        topic: "Fourier & PDE",
        difficulty: "nightmare",
        type: "multipleChoice",
        prompt: "For $u_t = 9u_{xx}$ on $(0,\\pi)$ with $u(0,t)=u(\\pi,t)=0$ and $u(x,0)=3\\sin 2x + 5\\sin 5x$, find $u(x,t)$.",
        options: [
          "$3e^{-36t}\\sin 2x + 5e^{-225t}\\sin 5x$",
          "$3e^{-4t}\\sin 2x + 5e^{-25t}\\sin 5x$",
          "$3e^{-18t}\\sin 2x + 5e^{-45t}\\sin 5x$",
          "$3e^{-9t}\\sin 2x + 5e^{-9t}\\sin 5x$"
        ],
        answerIndex: 0,
        hints: [
          "Mode $n$ decays like $e^{-9n^{2} t}$.",
          "Each sine term evolves independently."
        ],
        explanation: "Apply $e^{-9n^{2} t}$ to each mode to get $3e^{-36t}\\sin 2x + 5e^{-225t}\\sin 5x$."
      }
    ];

    const state = {
      currentQuestion: null,
      hintsRevealed: 0,
      attempts: 0,
      correct: 0,
      streak: 0,
      bestStreak: 0,
      flashcard: false,
      timer: null,
      timeRemaining: 180
    };

    const topicFilter = document.getElementById("topicFilter");
    const difficultyFilter = document.getElementById("difficultyFilter");
    const newQuestionBtn = document.getElementById("newQuestionBtn");
    const flashcardBtn = document.getElementById("flashcardBtn");
    const checkAnswerBtn = document.getElementById("checkAnswerBtn");
    const hintBtn = document.getElementById("hintBtn");
    const solutionBtn = document.getElementById("solutionBtn");
    const promptEl = document.getElementById("prompt");
    const optionsEl = document.getElementById("options");
    const topicTag = document.getElementById("topicTag");
    const difficultyTag = document.getElementById("difficultyTag");
    const feedbackEl = document.getElementById("feedback");
    const hintStageEl = document.getElementById("hintStage");
    const solutionBlock = document.getElementById("solutionBlock");
    const scoreCounter = document.getElementById("scoreCounter");
    const accuracyBar = document.getElementById("accuracyBar");
    const accuracyLabel = document.getElementById("accuracyLabel");
    const streakLabel = document.getElementById("streakLabel");
    const historyLog = document.getElementById("historyLog");
    const timerDisplay = document.getElementById("timerDisplay");
    const startTimerBtn = document.getElementById("startTimerBtn");
    const stopTimerBtn = document.getElementById("stopTimerBtn");

    function populateTopics() {
      const topics = ["all", ...new Set(questionBank.map(q => q.topic))];
      topics.forEach(topic => {
        const option = document.createElement("option");
        option.value = topic;
        option.textContent = topic === "all" ? "All Topics" : topic;
        topicFilter.appendChild(option);
      });
    }

    function filteredQuestions() {
      return questionBank.filter(q => {
        const topicMatch = topicFilter.value === "all" || q.topic === topicFilter.value;
        const diffMatch = difficultyFilter.value === "all" || q.difficulty === difficultyFilter.value;
        return topicMatch && diffMatch;
      });
    }

    function pickQuestion() {
      const pool = filteredQuestions();
      if (!pool.length) {
        return null;
      }
      const fresh = pool.filter(q => q.id !== state.currentQuestion?.id);
      const usable = fresh.length ? fresh : pool;
      return usable[Math.floor(Math.random() * usable.length)];
    }

    function renderQuestion(question) {
      promptEl.innerHTML = question ? question.prompt : "☠️ No creatures lurk in these shadows... Adjust your filter to awaken the horrors that await!";
      topicTag.textContent = question ? question.topic : "🔮 None Summoned";
      difficultyTag.textContent = question ? (difficultyNames[question.difficulty] || question.difficulty) : "Terror Level: Unknown";
      optionsEl.innerHTML = "";
      hintStageEl.innerHTML = "";
      solutionBlock.innerHTML = "";
      solutionBlock.classList.remove("active");
      feedbackEl.textContent = "";
      feedbackEl.className = "feedback";
      state.hintsRevealed = 0;

      if (!question) {
        return;
      }

      if (question.type === "multipleChoice") {
        question.options.forEach((optionText, index) => {
          const label = document.createElement("label");
          label.className = "option-card";
          label.innerHTML = `
            <input type="radio" name="answer" value="${index}">
            <span>${optionText}</span>
          `;
          optionsEl.appendChild(label);
        });
      } else {
        const wrapper = document.createElement("div");
        wrapper.className = "option-card free-response";
        wrapper.innerHTML = `<input type="text" id="freeResponseInput" placeholder="Type your answer">`;
        optionsEl.appendChild(wrapper);
      }

      if (window.MathJax && MathJax.typesetPromise) {
        MathJax.typesetPromise();
      }
    }

    function requestQuestion() {
      const question = pickQuestion();
      state.currentQuestion = question;
      renderQuestion(question);
    }

    function numericMatch(value, answer) {
      const num = Number(value);
      if (Number.isNaN(num)) return false;
      const tol = answer.tolerance ?? 0;
      return Math.abs(num - answer.value) <= tol;
    }

    function gradeQuestion() {
      const question = state.currentQuestion;
      if (!question) {
        feedbackEl.textContent = "⚰️ Summon a demon from the abyss first, fool!";
        feedbackEl.classList.add("error");
        return;
      }

      let correct = false;
      if (question.type === "multipleChoice") {
        const choice = optionsEl.querySelector("input[name='answer']:checked");
        if (!choice) {
          feedbackEl.textContent = "🗡️ Choose your weapon before facing the beast!";
          feedbackEl.classList.add("error");
          return;
        }
        correct = Number(choice.value) === question.answerIndex;
      } else {
        const input = document.getElementById("freeResponseInput");
        if (!input || !input.value.trim()) {
          feedbackEl.textContent = "💀 Speak your answer or be consumed by darkness!";
          feedbackEl.classList.add("error");
          return;
        }
        correct = question.answer.type === "numeric"
          ? numericMatch(input.value.trim(), question.answer)
          : question.answer.acceptable.some(a => a.toLowerCase() === input.value.trim().toLowerCase());
      }

      state.attempts += 1;
      if (correct) {
        state.correct += 1;
        state.streak += 1;
        state.bestStreak = Math.max(state.bestStreak, state.streak);
        const victories = [
          "⚔️ DEMON SLAIN! Its death scream echoes through the void...",
          "🗡️ MONSTER VANQUISHED! Blood splattered across ancient tomes!",
          "💀 BEAST DESTROYED! You step over its smoldering corpse...",
          "🔥 NIGHTMARE BANISHED! The shadows retreat... for now.",
          "⚰️ CREATURE ELIMINATED! Another soul freed from torment!"
        ];
        feedbackEl.textContent = victories[Math.floor(Math.random() * victories.length)];
        feedbackEl.className = "feedback success";
        logHistory(question, true);
      } else {
        state.streak = 0;
        const failures = [
          "☠️ WRONG! The beast FEASTS on your failure! Blood drips from its fangs...",
          "💀 INCORRECT! You feel your soul being drained... The vampire grows stronger!",
          "🩸 FAILED! Screams of agony fill the crypt as darkness consumes you!",
          "⚰️ DEATH! The creature tears into your flesh! Try again... IF YOU DARE!",
          "👻 DOOMED! Your mistake awakens MORE horrors from their slumber!"
        ];
        feedbackEl.textContent = failures[Math.floor(Math.random() * failures.length)];
        feedbackEl.className = "feedback error";
        logHistory(question, false);
      }

      const accuracy = state.attempts ? Math.round((state.correct / state.attempts) * 100) : 0;
      scoreCounter.textContent = `${state.correct} / ${state.attempts}`;
      accuracyBar.value = accuracy;
      accuracyLabel.textContent = `Survival Rate: ${accuracy}%`;
      streakLabel.textContent = `Kill Streak: ${state.streak} (Best ${state.bestStreak})`;

      if (state.flashcard && question.type === "multipleChoice") {
        revealSolution();
      }
    }

    function revealHint() {
      const question = state.currentQuestion;
      if (!question) {
        feedbackEl.textContent = "👻 Summon a nightmare first, mortal!";
        feedbackEl.classList.add("error");
        return;
      }
      if (!question.hints || state.hintsRevealed >= question.hints.length) {
        feedbackEl.textContent = "🕯️ The spirits have spoken all they know... You're on your own now!";
        feedbackEl.classList.remove("success", "error");
        return;
      }
      const text = question.hints[state.hintsRevealed];
      const p = document.createElement("p");
      p.innerHTML = `<strong style="color: #c77dff;">👻 Spectral Whisper ${state.hintsRevealed + 1}:</strong> ${text}`;
      p.style.borderColor = "rgba(157, 74, 221, 0.6)";
      p.style.background = "rgba(0, 0, 0, 0.6)";
      hintStageEl.appendChild(p);
      state.hintsRevealed += 1;
      if (window.MathJax && MathJax.typesetPromise) {
        MathJax.typesetPromise();
      }
    }

    function revealSolution() {
      const question = state.currentQuestion;
      if (!question) {
        feedbackEl.textContent = "⚰️ No demon has been summoned yet!";
        feedbackEl.classList.add("error");
        return;
      }
      solutionBlock.innerHTML = `<strong style="color: #c77dff;">⚰️ DEATH'S ANSWER:</strong> ${question.explanation}`;
      solutionBlock.style.borderColor = "rgba(157, 74, 221, 0.7)";
      solutionBlock.style.background = "rgba(0, 0, 0, 0.8)";
      solutionBlock.classList.add("active");
      if (window.MathJax && MathJax.typesetPromise) {
        MathJax.typesetPromise();
      }
    }

    function toggleFlashcard() {
      state.flashcard = !state.flashcard;
      flashcardBtn.classList.toggle("secondary", state.flashcard);
      flashcardBtn.textContent = state.flashcard ? "🕯️ CURSED MODE: ACTIVE" : "🕯️ Cursed Study Mode";
    }

    function logHistory(question, wasCorrect) {
      const entry = document.createElement("div");
      entry.style.padding = "0.5rem 0";
      entry.style.borderBottom = "1px solid rgba(157,74,221,0.4)";
      entry.innerHTML = `
        <div style="font-size:0.75rem; letter-spacing:0.08em; text-transform:uppercase; color:#e0aaff;">
          ⏰ ${new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}
        </div>
        <div style="font-weight:600; color:#c77dff;">${question.topic} &bull; ${difficultyNames[question.difficulty] || question.difficulty}</div>
        <div style="color:${wasCorrect ? '#c77dff' : '#9d4edd'}; font-weight: 700;">
          ${wasCorrect ? "⚔️ SLAYED" : "💀 KILLED YOU"}
        </div>
      `;
      historyLog.prepend(entry);
      while (historyLog.childElementCount > 10) {
        historyLog.removeChild(historyLog.lastChild);
      }
    }

    function updateTimerDisplay() {
      const m = Math.floor(state.timeRemaining / 60);
      const s = state.timeRemaining % 60;
      timerDisplay.textContent = `${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
    }

    function tickTimer() {
      if (state.timeRemaining <= 0) {
        clearInterval(state.timer);
        state.timer = null;
        feedbackEl.textContent = "⏰ TIME'S UP! The sun rises... but did you escape the crypt alive? Count your kills!";
        feedbackEl.classList.add("success");
        return;
      }
      state.timeRemaining -= 1;
      updateTimerDisplay();
    }

    function startTimer() {
      if (state.timer) return;
      state.timeRemaining = 180;
      updateTimerDisplay();
      state.timer = setInterval(tickTimer, 1000);
      feedbackEl.textContent = "🔪 THE MASSACRE BEGINS! Slay as many demons as possible before the darkness claims you forever!";
      feedbackEl.classList.add("success");
    }

    function stopTimer() {
      if (state.timer) {
        clearInterval(state.timer);
        state.timer = null;
        feedbackEl.textContent = "🛑 You flee in terror... The beasts laugh at your cowardice!";
        feedbackEl.classList.remove("error", "success");
      }
    }

    function attachListeners() {
      newQuestionBtn.addEventListener("click", requestQuestion);
      flashcardBtn.addEventListener("click", toggleFlashcard);
      checkAnswerBtn.addEventListener("click", gradeQuestion);
      hintBtn.addEventListener("click", revealHint);
      solutionBtn.addEventListener("click", revealSolution);
      startTimerBtn.addEventListener("click", startTimer);
      stopTimerBtn.addEventListener("click", stopTimer);
    }

    function init() {
      populateTopics();
      attachListeners();
      updateTimerDisplay();
      requestQuestion();
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
