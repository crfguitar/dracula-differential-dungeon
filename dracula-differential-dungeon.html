<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dracula's Differential Dungeon</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --ink: #0d0b16;
      --velvet: #1c1424;
      --plum: #261733;
      --accent: #ff79c6;
      --accent-2: #50fa7b;
      --accent-3: #bd93f9;
      --text: #f8f8f2;
      --muted: #8a88a0;
      --danger: #ff5555;
      --success: #50fa7b;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Poppins", sans-serif;
      color: var(--text);
      background: radial-gradient(circle at 20% 15%, rgba(189, 147, 249, 0.16), transparent 55%),
        radial-gradient(circle at 80% 20%, rgba(80, 250, 123, 0.18), transparent 50%),
        linear-gradient(135deg, #05030a, #1b1025 55%, #231534);
    }

    header {
      padding: 2.6rem 9vw 1.3rem;
      text-align: left;
    }

    header h1 {
      margin: 0;
      font-size: clamp(2rem, 5vw, 3.5rem);
      letter-spacing: 0.08em;
      color: var(--accent);
      text-transform: uppercase;
      text-shadow: 0 0 18px rgba(255, 121, 198, 0.6);
    }

    header p {
      margin: 0.8rem 0 0;
      max-width: 640px;
      color: var(--muted);
      line-height: 1.6;
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1fr);
      gap: 1.8rem;
      padding: 0 9vw 3.5rem;
    }

    .panel {
      background: rgba(32, 22, 45, 0.94);
      border: 1px solid rgba(189, 147, 249, 0.18);
      border-radius: 22px;
      padding: 1.6rem;
      box-shadow: 0 18px 44px rgba(8, 6, 18, 0.7);
      backdrop-filter: blur(10px);
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1.4rem;
    }

    .controls label {
      display: flex;
      flex-direction: column;
      font-size: 0.8rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
      gap: 0.35rem;
    }

    select,
    button,
    input[type="text"] {
      border: none;
      border-radius: 999px;
      padding: 0.65rem 1.1rem;
      background: rgba(19, 13, 28, 0.9);
      color: var(--text);
      font-family: "Fira Code", monospace;
      font-size: 0.95rem;
      box-shadow: inset 0 0 0 1px rgba(189, 147, 249, 0.16);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    select:focus,
    input:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(189, 147, 249, 0.65);
    }

    button {
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      background: linear-gradient(135deg, rgba(255, 121, 198, 0.85), rgba(189, 147, 249, 0.85));
      box-shadow: 0 10px 24px rgba(255, 121, 198, 0.28);
      font-weight: 600;
    }

    button:hover {
      transform: translateY(-2px);
    }

    button.secondary {
      background: linear-gradient(135deg, rgba(80, 250, 123, 0.85), rgba(98, 114, 164, 0.75));
      box-shadow: 0 10px 22px rgba(80, 250, 123, 0.22);
    }

    button.ghost {
      background: transparent;
      box-shadow: inset 0 0 0 1px rgba(189, 147, 249, 0.35);
      color: var(--accent-3);
    }

    .question-card {
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
    }

    .question-header {
      display: flex;
      justify-content: space-between;
      gap: 0.8rem;
      align-items: baseline;
    }

    .topic-tag {
      font-size: 0.75rem;
      color: var(--accent-2);
      background: rgba(80, 250, 123, 0.1);
      padding: 0.35rem 0.7rem;
      border-radius: 999px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .difficulty-tag {
      font-size: 0.75rem;
      color: var(--accent-3);
      letter-spacing: 0.08em;
    }

    .prompt {
      background: rgba(18, 12, 28, 0.85);
      border-radius: 16px;
      padding: 1.1rem 1.3rem;
      font-family: "Fira Code", monospace;
      line-height: 1.6;
      box-shadow: inset 0 0 0 1px rgba(189, 147, 249, 0.22);
    }

    .options {
      display: grid;
      gap: 0.8rem;
    }

    .option-card {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: rgba(26, 18, 36, 0.9);
      border-radius: 12px;
      border: 1px solid transparent;
      transition: transform 0.2s ease, border 0.2s ease;
    }

    .option-card:hover {
      transform: translateY(-1px);
      border-color: rgba(189, 147, 249, 0.4);
    }

    .option-card input {
      accent-color: var(--accent-3);
      transform: scale(1.15);
    }

    .free-response input {
      width: 100%;
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .feedback {
      min-height: 1.8rem;
      font-weight: 600;
      letter-spacing: 0.05em;
    }

    .feedback.success {
      color: var(--success);
    }

    .feedback.error {
      color: var(--danger);
    }

    .hint-stage {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }

    .hint-stage p {
      margin: 0;
      padding: 0.75rem 1rem;
      border-radius: 12px;
      background: rgba(18, 12, 28, 0.8);
      border: 1px dashed rgba(189, 147, 249, 0.32);
      font-size: 0.95rem;
      color: var(--muted);
    }

    .solution {
      margin-top: 0.8rem;
      padding: 1rem 1.2rem;
      border-radius: 16px;
      background: rgba(15, 10, 24, 0.9);
      border: 1px solid rgba(189, 147, 249, 0.25);
      display: none;
    }

    .solution.active {
      display: block;
    }

    .sidebar {
      display: grid;
      gap: 1.3rem;
    }

    .stat-card {
      background: rgba(24, 17, 33, 0.92);
      border-radius: 18px;
      padding: 1.2rem;
      border: 1px solid rgba(189, 147, 249, 0.18);
      display: grid;
      gap: 0.7rem;
    }

    .stat-card h3 {
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--accent-3);
      font-size: 0.95rem;
    }

    .stat-value {
      font-family: "Fira Code", monospace;
      font-size: 1.6rem;
    }

    .timer {
      font-family: "Fira Code", monospace;
      font-size: 1.3rem;
      color: var(--accent-2);
    }

    progress {
      width: 100%;
      height: 10px;
      border-radius: 999px;
      overflow: hidden;
      background: rgba(55, 48, 78, 0.4);
    }

    progress::-webkit-progress-value {
      background: linear-gradient(135deg, rgba(80, 250, 123, 0.85), rgba(189, 147, 249, 0.85));
    }

    footer {
      padding: 2.5rem 9vw 3rem;
      color: var(--muted);
      text-align: center;
      font-size: 0.9rem;
    }

    .float-glow {
      position: fixed;
      top: -100px;
      left: -60px;
      width: 220px;
      height: 220px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(255, 121, 198, 0.38), rgba(255, 121, 198, 0));
      filter: blur(4px);
      pointer-events: none;
      animation: pulse 10s ease-in-out infinite alternate;
    }

    .bat {
      position: fixed;
      width: 70px;
      aspect-ratio: 1;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 32"><path fill="%23bd93f9" d="M9 13c4-5 9-9 16-9s7 2 7 2 0-3 3-3 3 3 3 3 0-2 3-2 5 4 5 4l4-2-1 4 3 3-4 2 2 5-5-2s-3 5-7 5-6-3-6-3-3 3-7 3-9-6-9-6l-5 2 2-6-4-1 3-3-1-4z"/></svg>') no-repeat center/contain;
      opacity: 0.45;
      pointer-events: none;
      animation: bat 14s linear infinite;
    }

    .bat:nth-of-type(2) {
      top: 18%;
      right: 12%;
      animation-duration: 18s;
      transform: scale(1.3);
    }

    .bat:nth-of-type(3) {
      bottom: 18%;
      left: 18%;
      animation-duration: 16s;
    }

    @keyframes pulse {
      from {
        transform: scale(0.85);
        opacity: 0.4;
      }
      to {
        transform: scale(1.05);
        opacity: 0.75;
      }
    }

    @keyframes bat {
      0% {
        transform: translateY(0) translateX(-10px);
      }
      25% {
        transform: translateY(-14px) translateX(20px);
      }
      50% {
        transform: translateY(6px) translateX(35px);
      }
      75% {
        transform: translateY(-18px) translateX(5px);
      }
      100% {
        transform: translateY(0) translateX(-10px);
      }
    }

    @media (max-width: 980px) {
      main {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 720px) {
      .controls {
        flex-direction: column;
        align-items: stretch;
      }

      button,
      select,
      input {
        width: 100%;
      }

      .actions {
        flex-direction: column;
      }
    }
  </style>
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [["$", "$"], ["\\\\(", "\\\\)"]],
        displayMath: [["$$", "$$"], ["\\\\[", "\\\\]"]]
      },
      svg: { fontCache: "global" },
      options: { renderActions: { addMenu: [] } }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
</head>
<body>
  <div class="float-glow"></div>
  <div class="bat" style="top: 12%; left: 22%;"></div>
  <div class="bat"></div>
  <div class="bat"></div>
  <header>
    <h1>Dracula's Differential Dungeon</h1>
    <p>
      Step into the candlelit hall, challenger. Wrestle first-order phantoms, charm Laplace spirits, and race the clock
      before sunrise. Every correct answer adds garlic to your arsenal.
    </p>
  </header>
  <main>
    <section class="panel">
      <div class="controls">
        <label>
          Topic
          <select id="topicFilter"></select>
        </label>
        <label>
          Difficulty
          <select id="difficultyFilter">
            <option value="all">All</option>
            <option value="coffin">Coffin Cozy</option>
            <option value="fang">Fang Sharp</option>
            <option value="nightmare">Final Nightmare</option>
          </select>
        </label>
        <button id="newQuestionBtn">Summon</button>
        <button id="flashcardBtn" class="ghost">Flashcard Mode</button>
      </div>
      <div class="question-card">
        <div class="question-header">
          <span class="topic-tag" id="topicTag">Choose a topic</span>
          <span class="difficulty-tag" id="difficultyTag">Difficulty</span>
        </div>
        <div class="prompt" id="prompt">
          Ready to duel? Select your filters and hit Summon to conjure a fresh threat.
        </div>
        <div class="options" id="options"></div>
        <div class="actions">
          <button id="checkAnswerBtn" class="secondary">Check Answer</button>
          <button id="hintBtn" class="ghost">Hint</button>
          <button id="solutionBtn" class="ghost">Reveal Solution</button>
        </div>
        <div class="feedback" id="feedback"></div>
        <div class="hint-stage" id="hintStage"></div>
        <div class="solution" id="solutionBlock"></div>
      </div>
    </section>
    <aside class="sidebar">
      <div class="stat-card">
        <h3>Score</h3>
        <div class="stat-value" id="scoreCounter">0 / 0</div>
        <progress id="accuracyBar" value="0" max="100"></progress>
        <span id="accuracyLabel">Accuracy: 0%</span>
        <span id="streakLabel">Streak: 0 (Best 0)</span>
      </div>
      <div class="stat-card">
        <h3>Speedrun</h3>
        <div class="timer" id="timerDisplay">03:00</div>
        <div class="actions" style="margin-top: 0.4rem;">
          <button id="startTimerBtn">Start Hunt</button>
          <button id="stopTimerBtn" class="ghost">Stop</button>
        </div>
        <p style="margin:0; color: var(--muted); font-size:0.85rem;">
          Score as many victories as you can in 180 seconds. Garlic bonus for streaks!
        </p>
      </div>
      <div class="stat-card">
        <h3>Dungeon Log</h3>
        <div id="historyLog" style="max-height: 200px; overflow-y: auto; font-size: 0.9rem; color: var(--muted);"></div>
      </div>
      <div class="stat-card">
        <h3>Ritual Loop</h3>
        <ol style="margin:0; padding-left: 1.1rem; color: var(--muted); line-height: 1.6;">
          <li>Sketch the plan before pressing Check.</li>
          <li>Use hints sparingly to keep your streak glowing.</li>
          <li>Log reflections after each summoned foe.</li>
        </ol>
      </div>
    </aside>
  </main>
  <footer>
    From your nocturnal calculus coach: trust your structure, test your steady states, and keep every Dracula derivative continuous.
  </footer>
  <script>
    const difficultyNames = {
      coffin: "Coffin Cozy",
      fang: "Fang Sharp",
      nightmare: "Final Nightmare"
    };

    const questionBank = [
      {
        id: "linear-if",
        topic: "First-Order Linear",
        difficulty: "coffin",
        type: "multipleChoice",
        prompt: "Solve the IVP $y' + 2y = e^{x}$ with $y(0)=0$.",
        options: [
          "$y(x) = \\tfrac{1}{3} e^{x} - \\tfrac{1}{3} e^{-2x}$",
          "$y(x) = e^{x} - e^{-2x}$",
          "$y(x) = \\tfrac{1}{2} e^{x} - \\tfrac{1}{2} e^{-2x}$",
          "$y(x) = e^{-2x}$"
        ],
        answerIndex: 0,
        hints: [
          "Integrating factor: $\\mu(x) = e^{2x}$.",
          "Solve $e^{2x} y = \\int e^{3x}\\,dx$ and apply the initial value."
        ],
        explanation: "Multiplying by $e^{2x}$ gives $\\frac{d}{dx}(e^{2x}y) = e^{3x}$. Integrate to get $e^{2x}y = \\tfrac{1}{3} e^{3x} + C$, and $y(0)=0$ forces $C = -\\tfrac{1}{3}$. Thus $y = \\tfrac{1}{3} e^{x} - \\tfrac{1}{3} e^{-2x}$."
      },
      {
        id: "separable-1",
        topic: "Separable",
        difficulty: "coffin",
        type: "multipleChoice",
        prompt: "Solve $\\dfrac{dy}{dx} = y \\cos x$ with $y(0)=3$.",
        options: [
          "$y = 3 e^{\\sin x}$",
          "$y = 3 e^{\\cos x}$",
          "$y = 3 e^{1-\\sin x}$",
          "$y = 3 e^{-\\sin x}$"
        ],
        answerIndex: 0,
        hints: [
          "Separate: $\\dfrac{dy}{y} = \\cos x\\,dx$.",
          "Integrate both sides and use $y(0)=3$."
        ],
        explanation: "$\\ln|y| = \\sin x + C$ leads to $y = 3 e^{\\sin x}$ after using the initial value."
      },
      {
        id: "exact-1",
        topic: "Exact",
        difficulty: "fang",
        type: "multipleChoice",
        prompt: "For $(2xy + 1)dx + (x^{2} + 4y)dy = 0$, choose the implicit solution.",
        options: [
          "$x^{2}y + x + 2y^{2} = C$",
          "$x^{2}y + 2x + 2y^{2} = C$",
          "$x^{2}y + x + 4y^{2} = C$",
          "$x^{2}y + 2y^{2} = C$"
        ],
        answerIndex: 0,
        hints: [
          "$M_y = N_x = 2x$ so the form is exact.",
          "Integrate $M$ with respect to $x$, then match with $N$."
        ],
        explanation: "Integrating $M$ gives $x^{2}y + x + g(y)$. Matching $N$ forces $g'(y)=4y$, so $g=2y^{2}$."
      },
      {
        id: "second-order-ivp",
        topic: "Second-Order Linear",
        difficulty: "nightmare",
        type: "shortAnswer",
        prompt: "Solve $y'' - 3y' + 2y = 0$ with $y(0)=1$, $y'(0)=0$ and report $y(1)$ rounded to three decimals.",
        answer: { type: "numeric", value: -1.953, tolerance: 0.01 },
        hints: [
          "Roots of $r^{2} - 3r + 2$ are $1$ and $2$.",
          "Solve for $C_{1}, C_{2}$, then evaluate at $x=1$."
        ],
        explanation: "The solution $y = 2e^{x} - e^{2x}$ gives $y(1) = 2e - e^{2} \\approx -1.953$."
      },
      {
        id: "laplace-1",
        topic: "Laplace Transforms",
        difficulty: "fang",
        type: "multipleChoice",
        prompt: "Compute $\\mathcal{L}\\{t e^{2t}\\}$.",
        options: [
          "$\\dfrac{1}{(s-2)^{2}}$",
          "$\\dfrac{s}{(s-2)^{2}}$",
          "$\\dfrac{1}{(s-2)^{3}}$",
          "$\\dfrac{2}{(s-2)^{2}}$"
        ],
        answerIndex: 0,
        hints: [
          "Use $\\mathcal{L}\\{t\\} = 1/s^{2}$ and the shift theorem.",
          "Replace $s$ by $s-2$."
        ],
        explanation: "Shifting gives $\\mathcal{L}\\{t e^{2t}\\} = 1/(s-2)^{2}$."
      },
      {
        id: "laplace-ivp",
        topic: "Laplace Transforms",
        difficulty: "nightmare",
        type: "multipleChoice",
        prompt: "Solve $y'' + 4y = 8\\sin(2t)$ with $y(0)=0$, $y'(0)=1$.",
        options: [
          "$y = \\tfrac{1}{2}\\sin(2t)$",
          "$y = \\tfrac{1}{2} t \\sin(2t)$",
          "$y = t \\sin(2t)$",
          "$y = \\tfrac{1}{2} t \\sin(2t) + \\tfrac{1}{2} \\cos(2t)$"
        ],
        answerIndex: 1,
        hints: [
          "Transform both sides and solve for $Y(s)$.",
          "Partial fractions produce a $t\\sin(2t)$ term."
        ],
        explanation: "$Y(s) = (s+2)/(s^{2}+4)^{2}$, so $y(t) = \\tfrac{1}{2} t \\sin(2t)$."
      },
      {
        id: "systems-spiral",
        topic: "Linear Systems",
        difficulty: "fang",
        type: "multipleChoice",
        prompt: "Classify the origin for $\\mathbf{x}' = \\begin{pmatrix}-1 & -4 \\\\ 1 & -1\\end{pmatrix} \\mathbf{x}$.",
        options: [
          "Stable node",
          "Unstable node",
          "Center",
          "Stable spiral"
        ],
        answerIndex: 3,
        hints: [
          "Characteristic values are $-1 \\pm 2i$.",
          "Negative real part means spiral sink."
        ],
        explanation: "Complex eigenvalues with negative real part imply a stable spiral."
      },
      {
        id: "logistic",
        topic: "Nonlinear Models",
        difficulty: "fang",
        type: "shortAnswer",
        prompt: "For $y' = 0.6y(1 - y/12)$, $y(0)=2$, compute $y(5)$ (1 decimal).",
        answer: { type: "numeric", value: 11.1, tolerance: 0.2 },
        hints: [
          "General form: $\\frac{M}{1+Ae^{-kt}}$ with $M=12$.",
          "Solve for $A$ using $y(0)=2$."
        ],
        explanation: "With $A=5$, $y(t) = \\frac{12}{1 + 5e^{-0.6t}}$, so $y(5) \\approx 11.1$."
      },
      {
        id: "heat-equation",
        topic: "Fourier & PDE",
        difficulty: "nightmare",
        type: "multipleChoice",
        prompt: "For $u_t = 9u_{xx}$ on $(0,\\pi)$ with $u(0,t)=u(\\pi,t)=0$ and $u(x,0)=3\\sin 2x + 5\\sin 5x$, find $u(x,t)$.",
        options: [
          "$3e^{-36t}\\sin 2x + 5e^{-225t}\\sin 5x$",
          "$3e^{-4t}\\sin 2x + 5e^{-25t}\\sin 5x$",
          "$3e^{-18t}\\sin 2x + 5e^{-45t}\\sin 5x$",
          "$3e^{-9t}\\sin 2x + 5e^{-9t}\\sin 5x$"
        ],
        answerIndex: 0,
        hints: [
          "Mode $n$ decays like $e^{-9n^{2} t}$.",
          "Each sine term evolves independently."
        ],
        explanation: "Apply $e^{-9n^{2} t}$ to each mode to get $3e^{-36t}\\sin 2x + 5e^{-225t}\\sin 5x$."
      }
    ];

    const state = {
      currentQuestion: null,
      hintsRevealed: 0,
      attempts: 0,
      correct: 0,
      streak: 0,
      bestStreak: 0,
      flashcard: false,
      timer: null,
      timeRemaining: 180
    };

    const topicFilter = document.getElementById("topicFilter");
    const difficultyFilter = document.getElementById("difficultyFilter");
    const newQuestionBtn = document.getElementById("newQuestionBtn");
    const flashcardBtn = document.getElementById("flashcardBtn");
    const checkAnswerBtn = document.getElementById("checkAnswerBtn");
    const hintBtn = document.getElementById("hintBtn");
    const solutionBtn = document.getElementById("solutionBtn");
    const promptEl = document.getElementById("prompt");
    const optionsEl = document.getElementById("options");
    const topicTag = document.getElementById("topicTag");
    const difficultyTag = document.getElementById("difficultyTag");
    const feedbackEl = document.getElementById("feedback");
    const hintStageEl = document.getElementById("hintStage");
    const solutionBlock = document.getElementById("solutionBlock");
    const scoreCounter = document.getElementById("scoreCounter");
    const accuracyBar = document.getElementById("accuracyBar");
    const accuracyLabel = document.getElementById("accuracyLabel");
    const streakLabel = document.getElementById("streakLabel");
    const historyLog = document.getElementById("historyLog");
    const timerDisplay = document.getElementById("timerDisplay");
    const startTimerBtn = document.getElementById("startTimerBtn");
    const stopTimerBtn = document.getElementById("stopTimerBtn");

    function populateTopics() {
      const topics = ["all", ...new Set(questionBank.map(q => q.topic))];
      topics.forEach(topic => {
        const option = document.createElement("option");
        option.value = topic;
        option.textContent = topic === "all" ? "All Topics" : topic;
        topicFilter.appendChild(option);
      });
    }

    function filteredQuestions() {
      return questionBank.filter(q => {
        const topicMatch = topicFilter.value === "all" || q.topic === topicFilter.value;
        const diffMatch = difficultyFilter.value === "all" || q.difficulty === difficultyFilter.value;
        return topicMatch && diffMatch;
      });
    }

    function pickQuestion() {
      const pool = filteredQuestions();
      if (!pool.length) {
        return null;
      }
      const fresh = pool.filter(q => q.id !== state.currentQuestion?.id);
      const usable = fresh.length ? fresh : pool;
      return usable[Math.floor(Math.random() * usable.length)];
    }

    function renderQuestion(question) {
      promptEl.innerHTML = question ? question.prompt : "No foes match that filter yet. Broaden your search.";
      topicTag.textContent = question ? question.topic : "None";
      difficultyTag.textContent = question ? (difficultyNames[question.difficulty] || question.difficulty) : "None";
      optionsEl.innerHTML = "";
      hintStageEl.innerHTML = "";
      solutionBlock.innerHTML = "";
      solutionBlock.classList.remove("active");
      feedbackEl.textContent = "";
      feedbackEl.className = "feedback";
      state.hintsRevealed = 0;

      if (!question) {
        return;
      }

      if (question.type === "multipleChoice") {
        question.options.forEach((optionText, index) => {
          const label = document.createElement("label");
          label.className = "option-card";
          label.innerHTML = `
            <input type="radio" name="answer" value="${index}">
            <span>${optionText}</span>
          `;
          optionsEl.appendChild(label);
        });
      } else {
        const wrapper = document.createElement("div");
        wrapper.className = "option-card free-response";
        wrapper.innerHTML = `<input type="text" id="freeResponseInput" placeholder="Type your answer">`;
        optionsEl.appendChild(wrapper);
      }

      if (window.MathJax && MathJax.typesetPromise) {
        MathJax.typesetPromise();
      }
    }

    function requestQuestion() {
      const question = pickQuestion();
      state.currentQuestion = question;
      renderQuestion(question);
    }

    function numericMatch(value, answer) {
      const num = Number(value);
      if (Number.isNaN(num)) return false;
      const tol = answer.tolerance ?? 0;
      return Math.abs(num - answer.value) <= tol;
    }

    function gradeQuestion() {
      const question = state.currentQuestion;
      if (!question) {
        feedbackEl.textContent = "Summon a problem first.";
        feedbackEl.classList.add("error");
        return;
      }

      let correct = false;
      if (question.type === "multipleChoice") {
        const choice = optionsEl.querySelector("input[name='answer']:checked");
        if (!choice) {
          feedbackEl.textContent = "Choose an option before striking.";
          feedbackEl.classList.add("error");
          return;
        }
        correct = Number(choice.value) === question.answerIndex;
      } else {
        const input = document.getElementById("freeResponseInput");
        if (!input || !input.value.trim()) {
          feedbackEl.textContent = "Enter an answer to cross the moat.";
          feedbackEl.classList.add("error");
          return;
        }
        correct = question.answer.type === "numeric"
          ? numericMatch(input.value.trim(), question.answer)
          : question.answer.acceptable.some(a => a.toLowerCase() === input.value.trim().toLowerCase());
      }

      state.attempts += 1;
      if (correct) {
        state.correct += 1;
        state.streak += 1;
        state.bestStreak = Math.max(state.bestStreak, state.streak);
        feedbackEl.textContent = "Victory! The specter dissolves into mist.";
        feedbackEl.className = "feedback success";
        logHistory(question, true);
      } else {
        state.streak = 0;
        feedbackEl.textContent = "Missed. The creature circles back.";
        feedbackEl.className = "feedback error";
        logHistory(question, false);
      }

      const accuracy = state.attempts ? Math.round((state.correct / state.attempts) * 100) : 0;
      scoreCounter.textContent = `${state.correct} / ${state.attempts}`;
      accuracyBar.value = accuracy;
      accuracyLabel.textContent = `Accuracy: ${accuracy}%`;
      streakLabel.textContent = `Streak: ${state.streak} (Best ${state.bestStreak})`;

      if (state.flashcard && question.type === "multipleChoice") {
        revealSolution();
      }
    }

    function revealHint() {
      const question = state.currentQuestion;
      if (!question) {
        feedbackEl.textContent = "Summon something before hinting.";
        feedbackEl.classList.add("error");
        return;
      }
      if (!question.hints || state.hintsRevealed >= question.hints.length) {
        feedbackEl.textContent = "All hints already drawn from the crypt.";
        feedbackEl.classList.remove("success", "error");
        return;
      }
      const text = question.hints[state.hintsRevealed];
      const p = document.createElement("p");
      p.innerHTML = `<strong>Hint ${state.hintsRevealed + 1}:</strong> ${text}`;
      hintStageEl.appendChild(p);
      state.hintsRevealed += 1;
      if (window.MathJax && MathJax.typesetPromise) {
        MathJax.typesetPromise();
      }
    }

    function revealSolution() {
      const question = state.currentQuestion;
      if (!question) {
        feedbackEl.textContent = "No puzzle summoned.";
        feedbackEl.classList.add("error");
        return;
      }
      solutionBlock.innerHTML = `<strong>Solution:</strong> ${question.explanation}`;
      solutionBlock.classList.add("active");
      if (window.MathJax && MathJax.typesetPromise) {
        MathJax.typesetPromise();
      }
    }

    function toggleFlashcard() {
      state.flashcard = !state.flashcard;
      flashcardBtn.classList.toggle("secondary", state.flashcard);
      flashcardBtn.textContent = state.flashcard ? "Flashcard Mode: ON" : "Flashcard Mode";
    }

    function logHistory(question, wasCorrect) {
      const entry = document.createElement("div");
      entry.style.padding = "0.5rem 0";
      entry.style.borderBottom = "1px solid rgba(189,147,249,0.2)";
      entry.innerHTML = `
        <div style="font-size:0.75rem; letter-spacing:0.08em; text-transform:uppercase; color:var(--muted);">
          ${new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}
        </div>
        <div style="font-weight:600;">${question.topic} &bull; ${difficultyNames[question.difficulty] || question.difficulty}</div>
        <div style="color:${wasCorrect ? 'var(--accent-2)' : 'var(--danger)'};">
          ${wasCorrect ? "Vanquished" : "Escaped"}
        </div>
      `;
      historyLog.prepend(entry);
      while (historyLog.childElementCount > 10) {
        historyLog.removeChild(historyLog.lastChild);
      }
    }

    function updateTimerDisplay() {
      const m = Math.floor(state.timeRemaining / 60);
      const s = state.timeRemaining % 60;
      timerDisplay.textContent = `${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
    }

    function tickTimer() {
      if (state.timeRemaining <= 0) {
        clearInterval(state.timer);
        state.timer = null;
        feedbackEl.textContent = "Time! Count your conquests.";
        feedbackEl.classList.add("success");
        return;
      }
      state.timeRemaining -= 1;
      updateTimerDisplay();
    }

    function startTimer() {
      if (state.timer) return;
      state.timeRemaining = 180;
      updateTimerDisplay();
      state.timer = setInterval(tickTimer, 1000);
      feedbackEl.textContent = "Speedrun engaged. Slash swiftly!";
      feedbackEl.classList.add("success");
    }

    function stopTimer() {
      if (state.timer) {
        clearInterval(state.timer);
        state.timer = null;
        feedbackEl.textContent = "Timer halted. Regain your pulse.";
        feedbackEl.classList.remove("error", "success");
      }
    }

    function attachListeners() {
      newQuestionBtn.addEventListener("click", requestQuestion);
      flashcardBtn.addEventListener("click", toggleFlashcard);
      checkAnswerBtn.addEventListener("click", gradeQuestion);
      hintBtn.addEventListener("click", revealHint);
      solutionBtn.addEventListener("click", revealSolution);
      startTimerBtn.addEventListener("click", startTimer);
      stopTimerBtn.addEventListener("click", stopTimer);
    }

    function init() {
      populateTopics();
      attachListeners();
      updateTimerDisplay();
      requestQuestion();
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
